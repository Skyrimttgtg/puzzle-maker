<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Maker - URL Optimizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 40px 0; box-sizing: border-box; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: fit-content; text-align: center; }
        #play-wrapper { display: flex; align-items: flex-start; gap: 25px; max-width: 95%; justify-content: center; }
        #puzzle-board { display: grid; gap: 4px; margin: 20px auto; background: #eee; padding: 10px; border-radius: 8px; width: fit-content; }
        .tile { cursor: move; background-repeat: no-repeat; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .hidden { display: none; }
        button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-green { background: #2ecc71; }
        .btn-blue { background: var(--primary); }
        #timer-display { font-size: 1.5rem; font-weight: bold; color: white; margin-bottom: 10px; background: #d63031; padding: 5px 20px; border-radius: 50px; display: inline-block; transition: 0.5s; }
        .btn-done { background: #34495e; margin-top: 20px; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-8px); } 50% { transform: translateX(8px); } 75% { transform: translateX(-8px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.3s ease-in-out; background: #e74c3c !important; }
        #preview-box { width: 100%; height: 180px; border: 2px dashed #ccc; border-radius: 12px; margin: 20px 0; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; }
        #preview-img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body>

    <div id="setup-page" class="container">
        <h1>üß© Puzzle Link Optimizer</h1>
        <div id="preview-box" onclick="document.getElementById('imageInput').click()">
            <span id="txt">Pilih Foto</span>
            <img id="preview-img" class="hidden">
        </div>
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <input type="number" id="gridCol" value="3" min="2" max="5" style="width: 50px; padding: 5px;">
            <span>X</span>
            <input type="number" id="gridRow" value="3" min="2" max="5" style="width: 50px; padding: 5px;">
        </div>

        <button class="btn-green" onclick="copyLink()">üìã Salin Link Pendek</button>
        <button class="btn-blue" onclick="openPreview()">üëÅÔ∏è Main Sekarang</button>
        <p id="msg" style="font-size: 0.8rem; color: green;"></p>
    </div>

    <div id="play-page" class="hidden">
        <div id="play-wrapper">
            <div class="container">
                <div id="timer-display">00:00</div>
                <div id="puzzle-board"></div>
                <button id="finishBtn" class="btn-done" onclick="handleFinish()">‚úÖ Selesai</button>
            </div>
            <div class="container" style="padding: 1rem;">
                <span style="font-weight: bold; color: #666;">Panduan</span><br>
                <img id="hint-img-src" style="border-radius: 8px; margin-top: 10px; border: 1px solid #ddd;">
            </div>
        </div>
    </div>

    <script>
        let imgData = "";
        let timerInterval, seconds = 0, isFinished = false, dragged = null;

        document.getElementById('imageInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    // Paksa ukuran ke 120px untuk Link (Ukuran sangat krusial biar link pendek)
                    canvas.width = 120; canvas.height = (img.height/img.width)*120;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    imgData = canvas.toDataURL('image/jpeg', 0.2); // Kualitas rendah khusus link
                    
                    document.getElementById('preview-img').src = imgData;
                    document.getElementById('preview-img').classList.remove('hidden');
                    document.getElementById('txt').classList.add('hidden');
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function copyLink() {
            if (!imgData) return alert("Pilih foto!");
            const c = document.getElementById('gridCol').value;
            const r = document.getElementById('gridRow').value;
            
            // KOMPRESI TINGKAT TINGGI: Mengubah Base64 jadi kode super pendek
            const compressed = LZString.compressToEncodedURIComponent(imgData);
            const url = window.location.origin + window.location.pathname + `?p=${compressed}&c=${c}&r=${r}`;
            
            navigator.clipboard.writeText(url).then(() => {
                document.getElementById('msg').innerText = "‚úÖ Link Siap! (Sudah Dikompres)";
                setTimeout(() => document.getElementById('msg').innerText = "", 3000);
            });
        }

        // --- Logika Render & Game ---
        function handleFinish() {
            if (isFinished) return;
            const tiles = Array.from(document.querySelectorAll('.tile'));
            const win = tiles.every(t => t.dataset.currentIndex === t.dataset.targetIndex);
            if (win) {
                clearInterval(timerInterval); isFinished = true;
                document.getElementById('timer-display').style.background = "#2ecc71";
            } else {
                document.getElementById('finishBtn').classList.add('shake');
                setTimeout(() => document.getElementById('finishBtn').classList.remove('shake'), 300);
            }
        }

        function render(data, cols, rows) {
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('play-page').classList.remove('hidden');
            
            // Timer logic
            timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds/60).toString().padStart(2,'0');
                const s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer-display').innerText = `${m}:${s}`;
            }, 1000);

            const board = document.getElementById('puzzle-board');
            const hint = document.getElementById('hint-img-src');
            hint.src = data; hint.style.width = "150px";
            
            board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            let pieces = Array.from({length: cols*rows}, (_, i) => i);
            let shuffled = [...pieces].sort(() => Math.random() - 0.5);

            shuffled.forEach((orig, curr) => {
                const tile = document.createElement('div');
                tile.className = 'tile'; tile.draggable = true;
                tile.style.width = '70px'; tile.style.height = '70px';
                tile.style.backgroundImage = `url(${data})`;
                tile.style.backgroundSize = `${cols*100}% ${rows*100}%`;
                tile.dataset.targetIndex = curr; tile.dataset.currentIndex = orig;
                
                const r = Math.floor(orig/cols), c = orig%cols;
                tile.style.backgroundPosition = `${cols>1?(c/(cols-1))*100:0}% ${rows>1?(r/(rows-1))*100:0}%`;

                tile.addEventListener('dragstart', e => dragged = tile);
                tile.addEventListener('dragover', e => e.preventDefault());
                tile.addEventListener('drop', function() {
                    let b = this.style.backgroundPosition, i = this.dataset.currentIndex;
                    this.style.backgroundPosition = dragged.style.backgroundPosition;
                    this.dataset.currentIndex = dragged.dataset.currentIndex;
                    dragged.style.backgroundPosition = b;
                    dragged.dataset.currentIndex = i;
                });
                board.appendChild(tile);
            });
        }

        function openPreview() {
            if (!imgData) return alert("Pilih foto!");
            render(imgData, document.getElementById('gridCol').value, document.getElementById('gridRow').value);
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('p')) {
                // DEKOMPRESI: Mengembalikan kode pendek jadi gambar lagi
                const decoded = LZString.decompressFromEncodedURIComponent(params.get('p'));
                render(decoded, params.get('c'), params.get('r'));
            }
        };
    </script>
</body>
</html>
