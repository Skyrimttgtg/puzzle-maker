<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzle Maker - TinyURL Auto</title>
    <style>
        :root { --primary: #6c5ce7; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 40px 0; box-sizing: border-box; }
        #play-wrapper { display: flex; align-items: flex-start; gap: 25px; max-width: 95%; justify-content: center; }
        .container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: fit-content; text-align: center; }
        #hint-container { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        #hint-img-src { border-radius: 8px; display: block; border: 2px solid #ddd; }
        .hidden { display: none; }
        #preview-box { width: 100%; height: 180px; border: 2px dashed #ccc; border-radius: 12px; margin: 20px 0; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; }
        #preview-img { width: 100%; height: 100%; object-fit: contain; }
        #puzzle-board { display: grid; gap: 4px; margin: 20px auto; background: #eee; padding: 10px; border-radius: 8px; width: fit-content; }
        .tile { cursor: move; background-repeat: no-repeat; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-green { background: #2ecc71; }
        .btn-blue { background: var(--primary); }
        #timer-display { font-size: 1.5rem; font-weight: bold; color: white; margin-bottom: 10px; background: #d63031; padding: 5px 20px; border-radius: 50px; display: inline-block; transition: 0.5s; }
        .btn-done { background: #34495e; margin-top: 20px; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-8px); } 50% { transform: translateX(8px); } 75% { transform: translateX(-8px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.3s ease-in-out; background: #e74c3c !important; }
        @media (max-width: 900px) { #play-wrapper { flex-direction: column; align-items: center; } #hint-container { order: -1; } }
    </style>
</head>
<body>

    <div id="setup-page" class="container">
        <h1>üß© Custom Grid Puzzle</h1>
        <div id="preview-box" onclick="document.getElementById('imageInput').click()">
            <span id="txt">Klik & Pilih Foto</span>
            <img id="preview-img" class="hidden">
        </div>
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label>Kolom</label>
                <input type="number" id="gridCol" value="3" min="2" max="10" style="width: 60px; padding: 8px; text-align: center;">
            </div>
            <div style="align-self: flex-end; padding-bottom: 10px; font-weight: bold;">X</div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label>Baris</label>
                <input type="number" id="gridRow" value="3" min="2" max="10" style="width: 60px; padding: 8px; text-align: center;">
            </div>
        </div>

        <button id="copyBtn" class="btn-green" onclick="copyLink()">üîó Salin Link (TinyURL)</button>
        <button class="btn-blue" onclick="openPreview()">üëÅÔ∏è Review</button>
        <p id="msg" style="font-size: 0.8rem; color: #e67e22; font-weight: bold;"></p>
    </div>

    <div id="play-page" class="hidden">
        <div id="play-wrapper">
            <div class="container">
                <div id="timer-display">Waktu: 00:00</div>
                <h2>Susun Puzzlenya!</h2>
                <div id="puzzle-board"></div>
                <button id="finishBtn" class="btn-done" onclick="handleFinish()">‚úÖ Selesai</button>
            </div>
            <div id="hint-container">
                <span>Gambar Panduan</span>
                <img id="hint-img-src" src="" alt="Panduan">
            </div>
        </div>
    </div>

    <script>
        let imgData = "";
        let linkData = ""; 
        let dragged = null;
        let seconds = 0;
        let timerInterval;
        let isFinished = false;

        document.getElementById('imageInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Display Bagus
                    canvas.width = 400; canvas.height = (img.height/img.width)*400;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    imgData = canvas.toDataURL('image/jpeg', 0.8);

                    // Versi Link (Sangat Kecil agar TinyURL tidak error)
                    canvas.width = 100; canvas.height = (img.height/img.width)*100;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    linkData = canvas.toDataURL('image/jpeg', 0.1); 

                    document.getElementById('preview-img').src = imgData;
                    document.getElementById('preview-img').classList.remove('hidden');
                    document.getElementById('txt').classList.add('hidden');
                    localStorage.setItem('tempPuzzleImg', imgData);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        async function copyLink() {
            if (!linkData) return alert("Pilih foto dulu!");
            const btn = document.getElementById('copyBtn');
            const msg = document.getElementById('msg');
            const col = document.getElementById('gridCol').value;
            const row = document.getElementById('gridRow').value;
            
            btn.innerText = "‚è≥ Memproses...";
            btn.disabled = true;

            const fullUrl = window.location.origin + window.location.pathname + `?play=true&c=${col}&r=${row}&d=${encodeURIComponent(linkData)}`;

            try {
                // Menggunakan proxy API untuk memendekkan link via TinyURL secara otomatis
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(fullUrl)}`);
                const shortUrl = await response.text();

                if (shortUrl.startsWith('http')) {
                    await navigator.clipboard.writeText(shortUrl);
                    msg.innerText = "‚úÖ Link TinyURL berhasil disalin!";
                } else {
                    throw new Error();
                }
            } catch (err) {
                // Fallback jika API gagal (biasanya karena limit atau gambar terlalu besar)
                await navigator.clipboard.writeText(fullUrl);
                msg.innerText = "‚ö†Ô∏è Gagal otomatis. Link panjang disalin, silakan manual ke TinyURL.";
            } finally {
                btn.innerText = "üîó Salin Link (TinyURL)";
                btn.disabled = false;
                setTimeout(() => msg.innerText = "", 5000);
            }
        }

        // --- Logika Game Sisanya Tetap ---
        function openPreview() {
            if (!imgData) return alert("Pilih foto dulu!");
            renderPuzzle(imgData, document.getElementById('gridCol').value, document.getElementById('gridRow').value);
        }

        function startTimer() {
            clearInterval(timerInterval); seconds = 0; isFinished = false;
            timerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer-display').innerText = `Waktu: ${mins}:${secs}`;
            }, 1000);
        }

        function handleFinish() {
            if (isFinished) return;
            const btn = document.getElementById('finishBtn');
            const tiles = Array.from(document.querySelectorAll('.tile'));
            const isCorrect = tiles.every(tile => parseInt(tile.dataset.currentIndex) === parseInt(tile.dataset.targetIndex));
            if (isCorrect) {
                clearInterval(timerInterval); isFinished = true;
                document.getElementById('timer-display').style.background = "#2ecc71";
                btn.style.background = "#2ecc71"; btn.innerText = "üéâ Berhasil!";
            } else {
                btn.classList.add('shake'); setTimeout(() => btn.classList.remove('shake'), 300);
            }
        }

        function renderPuzzle(data, cols, rows) {
            document.getElementById('setup-page').classList.add('hidden');
            document.getElementById('play-page').classList.remove('hidden');
            startTimer();
            cols = parseInt(cols); rows = parseInt(rows);
            const baseTileSize = 75; const gap = 4;
            const hintImg = document.getElementById('hint-img-src');
            hintImg.style.width = `${(baseTileSize * cols) + (gap * (cols - 1))}px`;
            hintImg.style.height = `${(baseTileSize * rows) + (gap * (rows - 1))}px`;
            hintImg.src = data;

            const board = document.getElementById('puzzle-board');
            board.innerHTML = ''; board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            let pieces = Array.from({length: cols * rows}, (_, i) => i);
            let shuffled = [...pieces].sort(() => Math.random() - 0.5);

            shuffled.forEach((originalIndex, currentIndex) => {
                const tile = document.createElement('div');
                tile.className = 'tile'; tile.draggable = true;
                tile.style.width = `${baseTileSize}px`; tile.style.height = `${baseTileSize}px`;
                tile.style.backgroundImage = `url(${data})`;
                tile.style.backgroundSize = `${cols * 100}% ${rows * 100}%`;
                tile.dataset.targetIndex = currentIndex;
                tile.dataset.currentIndex = originalIndex;
                const rOrig = Math.floor(originalIndex / cols);
                const cOrig = originalIndex % cols;
                tile.style.backgroundPosition = `${cols > 1 ? (cOrig / (cols - 1)) * 100 : 0}% ${rows > 1 ? (rOrig / (rows - 1)) * 100 : 0}%`;

                tile.addEventListener('dragstart', (e) => { if(!isFinished) dragged = tile; });
                tile.addEventListener('dragover', (e) => e.preventDefault());
                tile.addEventListener('drop', function() {
                    if (this === dragged || isFinished) return;
                    let tmpBg = this.style.backgroundPosition;
                    this.style.backgroundPosition = dragged.style.backgroundPosition;
                    dragged.style.backgroundPosition = tmpBg;
                    let tmpIdx = this.dataset.currentIndex;
                    this.dataset.currentIndex = dragged.dataset.currentIndex;
                    dragged.dataset.currentIndex = tmpIdx;
                });
                board.appendChild(tile);
            });
        }

        window.onload = () => {
            const p = new URLSearchParams(window.location.search);
            if (p.has('play')) {
                let data = p.has('d') ? decodeURIComponent(p.get('d')) : localStorage.getItem('tempPuzzleImg');
                if (data) renderPuzzle(data, p.get('c'), p.get('r'));
            }
        };
    </script>
</body>
</html>
